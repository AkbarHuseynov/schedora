<%- include('../partials/head') %>
<%- include('../partials/navbar') %>

<div class="container py-5">
    <%- include('../partials/flash') %>

    <div class="page-header">
        <h2 data-i18n="<%= shop ? 'owner_shop_settings_title' : 'owner_shop_setup_title' %>"><%= shop ? 'Shop Settings' : 'Set Up Your Shop' %></h2>
        <p class="text-muted mb-0" data-i18n="<%= shop ? 'owner_shop_settings_sub' : 'owner_shop_setup_sub' %>"><%= shop ? 'Update your shop profile and details.' : 'Fill in your shop details to start accepting bookings.' %></p>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card-schedora p-4 p-md-5">
                <form action="/owner/shop/setup" method="POST" enctype="multipart/form-data">

                    <!-- Cover image -->
                    <div class="mb-4">
                        <label class="form-label" data-i18n="owner_shop_cover">Cover Image</label>
                        <% if (shop && shop.cover_image) { %>
                            <img src="/uploads/<%= shop.cover_image %>" id="coverPreviewImg"
                                 class="cover-preview d-block mb-2" style="display:block!important;">
                        <% } else { %>
                            <img id="coverPreviewImg" src="" class="cover-preview d-none mb-2">
                        <% } %>
                        <input type="file" name="cover_image" id="cover_image" class="form-control" accept="image/*">
                        <small class="text-muted" data-i18n="owner_shop_cover_help">Recommended: 1200√ó400px. Max 5MB.</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" data-i18n="owner_shop_name">Shop Name</label> <span class="text-danger">*</span>
                        <input type="text" name="name" class="form-control" required
                               value="<%= shop ? shop.name : '' %>" placeholder="e.g. The Golden Cut">
                    </div>

                    <div class="mb-3">
                        <label class="form-label" data-i18n="owner_shop_category">Category</label> <span class="text-danger">*</span>
                        <select name="category" class="form-select" required>
                            <option value="barber" <%= shop && shop.category === 'barber' ? 'selected' : '' %> data-i18n="shops_barber">Barber</option>
                            <option value="beauty" <%= shop && shop.category === 'beauty' ? 'selected' : '' %> data-i18n="shops_beauty">Beauty Salon</option>
                            <option value="spa"    <%= shop && shop.category === 'spa'    ? 'selected' : '' %> data-i18n="shops_spa">Spa</option>
                            <option value="laser"  <%= shop && shop.category === 'laser'  ? 'selected' : '' %> data-i18n="shops_laser">Laser</option>
                            <option value="other"  <%= shop && shop.category === 'other'  ? 'selected' : '' %> data-i18n="shops_other">Other</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" data-i18n="owner_shop_desc">Description</label>
                        <textarea name="description" class="form-control" rows="3"
                                  placeholder="Describe your shop and services..."
                                  data-i18n-placeholder="owner_shop_desc_ph"><%= shop ? shop.description : '' %></textarea>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-8">
                            <label class="form-label" data-i18n="owner_shop_address">Address</label>
                            <input type="text" name="address" id="address-input" class="form-control"
                                   value="<%= shop ? shop.address : '' %>" placeholder="123 Main St, City">
                            <small class="text-muted d-block mt-1">üí° Auto-filled when you select location on map</small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label" data-i18n="owner_shop_phone">Phone</label>
                            <input type="tel" name="phone" class="form-control"
                                   value="<%= shop ? shop.phone : '' %>" placeholder="+1 555 0000">
                        </div>
                    </div>

                    <!-- Location & Map Settings -->
                    <div class="mb-4">
                        <h5 class="fw-bold mb-3">Location & Map Settings</h5>
                        <p class="text-muted small mb-4">Control how your shop appears on the map and visibility to clients.</p>

                        <!-- Location coordinates (hidden, updated via map picker) -->
                        <input type="hidden" name="latitude" id="latitude-input" value="<%= shop && shop.latitude ? shop.latitude : '' %>">
                        <input type="hidden" name="longitude" id="longitude-input" value="<%= shop && shop.longitude ? shop.longitude : '' %>">

                        <!-- Location selection via map -->
                        <div class="mb-4">
                            <label class="form-label">Shop Location</label>
                            <p class="text-muted small mb-3">Click the button below to select your shop location on the map</p>
                            <button type="button" class="btn btn-lg btn-outline-secondary w-100 py-3" id="open-map-picker-btn">
                                <i class="bi bi-map me-2"></i>Select Location on Map
                            </button>
                            <!-- Show selected coordinates if set -->
                            <% if (shop && shop.latitude && shop.longitude) { %>
                                <div class="alert alert-success mt-3 mb-0">
                                    <i class="bi bi-check-circle me-2"></i>
                                    <strong>Location selected:</strong> <%= parseFloat(shop.latitude).toFixed(6) %>, <%= parseFloat(shop.longitude).toFixed(6) %>
                                </div>
                            <% } else { %>
                                <div class="alert alert-info mt-3 mb-0">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <strong>No location selected yet.</strong> Click the button above to choose your shop's location.
                                </div>
                            <% } %>
                        </div>

                        <!-- Location determination mode -->
                        <div class="mb-3">
                            <label class="form-label">Location Detection Mode</label>
                            <select name="location_mode" class="form-select">
                                <option value="manual" <%= settings && settings.location_mode === 'manual' ? 'selected' : '' %>>
                                    Manual (enter coordinates above)
                                </option>
                                <option value="auto" <%= settings && settings.location_mode === 'auto' ? 'selected' : '' %>>
                                    Automatic (from browser location)
                                </option>
                            </select>
                            <small class="text-muted d-block mt-2">
                                <strong>Manual:</strong> You enter exact coordinates<br>
                                <strong>Auto:</strong> Client's browser detects their location (when viewing map)
                            </small>
                        </div>

                        <!-- Map visibility -->
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" name="map_visible" id="map_visible" value="1"
                                   <%= settings && settings.map_visible ? 'checked' : '' %>>
                            <label class="form-check-label" for="map_visible">
                                <strong>Show map to clients</strong>
                                <small class="text-muted d-block">Display your shop location on the map when clients browse shops</small>
                            </label>
                        </div>

                        <!-- Distance display -->
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="show_distance" id="show_distance" value="1"
                                   <%= settings && settings.show_distance ? 'checked' : '' %>>
                            <label class="form-check-label" for="show_distance">
                                <strong>Show distance from client</strong>
                                <small class="text-muted d-block">Display approximate distance when clients view your shop (requires their location)</small>
                            </label>
                        </div>
                    </div>

                    <div class="d-flex gap-3 mt-4">
                        <a href="/owner/dashboard" class="btn-outline-gold flex-fill py-3 text-center" data-i18n="owner_shop_cancel">Cancel</a>
                        <button type="submit" class="btn-gold flex-fill py-3 fw-semibold">
                            <i class="bi bi-check-lg me-1"></i>
                            <span data-i18n="<%= shop ? 'owner_shop_save' : 'owner_shop_create' %>"><%= shop ? 'Save Changes' : 'Create Shop' %></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Location Picker Modal -->
<div class="modal fade" id="locationPickerModal" tabindex="-1" aria-labelledby="locationPickerLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="locationPickerLabel">Select Shop Location</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Search by Location Name with Autocomplete -->
                <div class="mb-3">
                    <label class="form-label small">Search by location name:</label>
                    <div class="position-relative">
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" id="location-search-input"
                                   placeholder="e.g., Flame Towers, Old City, Baku Park...">
                            <button class="btn btn-outline-secondary" type="button" id="location-search-btn">
                                <i class="bi bi-search"></i> Search
                            </button>
                        </div>
                        <!-- Autocomplete Suggestions Dropdown -->
                        <div id="search-suggestions" class="position-absolute w-100 bg-white border border-top-0 rounded-bottom shadow-sm" style="display: none; max-height: 200px; overflow-y: auto; z-index: 1000;">
                            <div id="suggestions-list"></div>
                        </div>
                    </div>
                </div>

                <!-- Map -->
                <div id="location-picker-map" style="height: 400px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd;"></div>

                <!-- Info Alert -->
                <div class="alert alert-info mb-0">
                    <small><i class="bi bi-info-circle me-2"></i>Click on the map to select your shop's location, or search by name above.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-gold" id="confirm-location-btn">Confirm Location</button>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet CSS & JS for location picker -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let locationPickerMap = null;
    let selectedMarker = null;
    let selectedLat = null;
    let selectedLng = null;
    const latInput = document.getElementById('latitude-input');
    const lngInput = document.getElementById('longitude-input');
    const openMapBtn = document.getElementById('open-map-picker-btn');
    const modal = new bootstrap.Modal(document.getElementById('locationPickerModal'));
    const confirmBtn = document.getElementById('confirm-location-btn');

    openMapBtn.addEventListener('click', function() {
        modal.show();
        // Initialize map on modal show (to avoid sizing issues)
        setTimeout(initializeLocationPicker, 500);
    });

    // Search by location name with autocomplete
    const searchBtn = document.getElementById('location-search-btn');
    const searchInput = document.getElementById('location-search-input');
    const suggestionsDiv = document.getElementById('search-suggestions');
    const suggestionsList = document.getElementById('suggestions-list');
    let searchTimeout;
    let selectedSuggestionIndex = -1;

    searchBtn.addEventListener('click', function() {
        searchLocation();
    });

    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            // If a suggestion is selected, use it
            if (selectedSuggestionIndex >= 0) {
                const suggestions = suggestionsList.querySelectorAll('.suggestion-item');
                if (suggestions[selectedSuggestionIndex]) {
                    suggestions[selectedSuggestionIndex].click();
                    return;
                }
            }
            searchLocation();
        }
    });

    // Real-time autocomplete as user types
    searchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();

        // Clear previous timeout
        clearTimeout(searchTimeout);

        if (query.length < 2) {
            suggestionsDiv.style.display = 'none';
            selectedSuggestionIndex = -1;
            return;
        }

        // Show loading state
        suggestionsList.innerHTML = '<div class="p-2 text-muted small"><i class="bi bi-hourglass-split"></i> Finding suggestions...</div>';
        suggestionsDiv.style.display = 'block';

        // Debounce the search (wait 300ms after user stops typing)
        searchTimeout = setTimeout(() => {
            fetchAutocompleteSuggestions(query);
        }, 300);
    });

    // Keyboard navigation in suggestions
    searchInput.addEventListener('keydown', function(e) {
        const suggestions = suggestionsList.querySelectorAll('.suggestion-item');
        const totalSuggestions = suggestions.length;

        if (totalSuggestions === 0) return;

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedSuggestionIndex = (selectedSuggestionIndex + 1) % totalSuggestions;
            updateSuggestionHighlight(suggestions);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedSuggestionIndex = selectedSuggestionIndex <= 0 ? totalSuggestions - 1 : selectedSuggestionIndex - 1;
            updateSuggestionHighlight(suggestions);
        } else if (e.key === 'Escape') {
            suggestionsDiv.style.display = 'none';
            selectedSuggestionIndex = -1;
        }
    });

    // Close suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#location-search-input') && !e.target.closest('#search-suggestions')) {
            suggestionsDiv.style.display = 'none';
            selectedSuggestionIndex = -1;
        }
    });

    function updateSuggestionHighlight(suggestions) {
        suggestions.forEach((item, idx) => {
            if (idx === selectedSuggestionIndex) {
                item.classList.add('bg-light');
                item.style.backgroundColor = '#f8f9fa';
            } else {
                item.classList.remove('bg-light');
                item.style.backgroundColor = '';
            }
        });
    }

    function fetchAutocompleteSuggestions(query) {
        // Use Nominatim API with viewbox for Baku area
        const nominatimUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&viewbox=48.5,39.5,50.5,41&bounded=1&limit=5`;

        fetch(nominatimUrl)
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    displaySuggestions(data);
                } else {
                    suggestionsList.innerHTML = '<div class="p-2 text-muted small">No suggestions found</div>';
                }
            })
            .catch(error => {
                console.error('Autocomplete error:', error);
                suggestionsList.innerHTML = '<div class="p-2 text-danger small">Error loading suggestions</div>';
            });
    }

    function displaySuggestions(results) {
        suggestionsList.innerHTML = '';
        selectedSuggestionIndex = -1;

        results.forEach((result, idx) => {
            const name = result.display_name.split(',')[0]; // Get first part (main place name)
            const address = result.display_name.substring(0, 60); // Truncate long addresses

            const suggestionItem = document.createElement('div');
            suggestionItem.className = 'suggestion-item p-2 border-bottom cursor-pointer';
            suggestionItem.style.cursor = 'pointer';
            suggestionItem.innerHTML = `
                <div class="small">
                    <strong>${name}</strong>
                    <br>
                    <span class="text-muted" style="font-size: 0.85rem;">${address}${address.length > 59 ? '...' : ''}</span>
                </div>
            `;

            suggestionItem.addEventListener('click', function() {
                selectSuggestion(result);
            });

            suggestionItem.addEventListener('mouseover', function() {
                selectedSuggestionIndex = idx;
                const items = suggestionsList.querySelectorAll('.suggestion-item');
                updateSuggestionHighlight(items);
            });

            suggestionsList.appendChild(suggestionItem);
        });
    }

    function selectSuggestion(result) {
        const lat = parseFloat(result.lat);
        const lng = parseFloat(result.lon);
        const displayName = result.display_name;

        // Update search input with selected location
        searchInput.value = displayName.split(',')[0];
        suggestionsDiv.style.display = 'none';
        selectedSuggestionIndex = -1;

        // Automatically zoom to location
        if (!locationPickerMap) {
            // Map not initialized yet, initialize and zoom to result
            setTimeout(() => {
                selectedLat = lat;
                selectedLng = lng;
                addMarker(lat, lng);
                if (locationPickerMap) {
                    locationPickerMap.setView([lat, lng], 15);
                }
                updateBadges();
            }, 500);
        } else {
            // Map already initialized, just zoom to result
            selectedLat = lat;
            selectedLng = lng;
            addMarker(lat, lng);
            locationPickerMap.setView([lat, lng], 15);
            updateBadges();
        }
    }

    function searchLocation() {
        const query = searchInput.value.trim();
        if (!query) {
            alert('Please enter a location name');
            return;
        }

        // Show loading state
        searchBtn.disabled = true;
        searchBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Searching...';

        // Use OpenStreetMap's Nominatim geocoding API
        // Focus on Baku area by adding bias
        const nominatimUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&viewbox=48.5,39.5,50.5,41&bounded=1&limit=1`;

        fetch(nominatimUrl)
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    const result = data[0];
                    const lat = parseFloat(result.lat);
                    const lng = parseFloat(result.lon);

                    // Ensure map is initialized
                    if (!locationPickerMap) {
                        setTimeout(() => {
                            selectedLat = lat;
                            selectedLng = lng;
                            addMarker(lat, lng);
                            locationPickerMap.setView([lat, lng], 15);
                            updateBadges();
                        }, 500);
                    } else {
                        selectedLat = lat;
                        selectedLng = lng;
                        addMarker(lat, lng);
                        locationPickerMap.setView([lat, lng], 15);
                        updateBadges();
                    }

                    // Clear search input
                    searchInput.value = '';
                } else {
                    alert('Location not found. Please try a different search term.');
                }
            })
            .catch(error => {
                console.error('Search error:', error);
                alert('Error searching location. Please try again.');
            })
            .finally(() => {
                // Restore button state
                searchBtn.disabled = false;
                searchBtn.innerHTML = '<i class="bi bi-search"></i> Search';
            });
    }

    function initializeLocationPicker() {
        if (locationPickerMap) return; // Already initialized

        // Get current coordinates or use Baku as default
        const currentLat = parseFloat(latInput.value) || 40.3856;  // Baku latitude
        const currentLng = parseFloat(lngInput.value) || 49.8671;  // Baku longitude

        locationPickerMap = L.map('location-picker-map').setView([currentLat, currentLng], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(locationPickerMap);

        // Add existing marker if coordinates already set
        if (latInput.value && lngInput.value) {
            selectedLat = parseFloat(latInput.value);
            selectedLng = parseFloat(lngInput.value);
            addMarker(selectedLat, selectedLng);
            updateBadges();
        }

        // Handle map clicks
        locationPickerMap.on('click', function(e) {
            selectedLat = e.latlng.lat;
            selectedLng = e.latlng.lng;
            addMarker(selectedLat, selectedLng);
            updateBadges();
        });
    }

    function addMarker(lat, lng) {
        if (selectedMarker) {
            locationPickerMap.removeLayer(selectedMarker);
        }
        selectedMarker = L.circleMarker([lat, lng], {
            radius: 10,
            fillColor: '#C9A96E',
            color: '#A8894E',
            weight: 3,
            opacity: 1,
            fillOpacity: 0.9
        }).addTo(locationPickerMap);

        // Add popup with address or coordinates
        const addressInput = document.getElementById('address-input');
        const addressText = addressInput && addressInput.value ?
            addressInput.value : `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

        selectedMarker.bindPopup(`
            <div class="text-center" style="max-width: 200px;">
                <strong>üìç Selected Location</strong><br>
                <small style="word-break: break-word;">${addressText}</small>
            </div>
        `).openPopup();

        // Center map on marker
        locationPickerMap.setView([lat, lng], locationPickerMap.getZoom());

        // Reverse geocode to get address automatically
        reverseGeocodeAddress(lat, lng);
    }

    function reverseGeocodeAddress(lat, lng) {
        // Use Nominatim reverse geocoding to get address from coordinates
        const nominatimUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;

        fetch(nominatimUrl)
            .then(response => response.json())
            .then(data => {
                if (data && data.address) {
                    // Build address from components
                    const addressParts = [];

                    // Add road/street name
                    if (data.address.road) {
                        addressParts.push(data.address.road);
                    }

                    // Add house number if available
                    if (data.address.house_number) {
                        addressParts[0] = (data.address.house_number + ' ' + (addressParts[0] || ''));
                    }

                    // Add suburb/neighborhood
                    if (data.address.suburb) {
                        addressParts.push(data.address.suburb);
                    } else if (data.address.neighbourhood) {
                        addressParts.push(data.address.neighbourhood);
                    }

                    // Add city
                    if (data.address.city) {
                        addressParts.push(data.address.city);
                    } else if (data.address.town) {
                        addressParts.push(data.address.town);
                    } else if (data.address.village) {
                        addressParts.push(data.address.village);
                    }

                    // Add country
                    if (data.address.country) {
                        addressParts.push(data.address.country);
                    }

                    // Create full address and update form
                    const fullAddress = addressParts.filter(Boolean).join(', ');
                    if (fullAddress) {
                        document.getElementById('address-input').value = fullAddress;
                    }
                }
            })
            .catch(error => {
                console.warn('Could not fetch address:', error);
                // Not critical - address can be entered manually
            });
    }

    function updateBadges() {
        // Badge display removed - coordinates are shown in marker popup instead
        // This function is kept for compatibility with existing code
    }

    confirmBtn.addEventListener('click', function() {
        if (selectedLat !== null && selectedLng !== null) {
            latInput.value = selectedLat;
            lngInput.value = selectedLng;
            modal.hide();
            // Clean up map on modal hide
            setTimeout(() => {
                if (locationPickerMap) {
                    locationPickerMap.off();
                    locationPickerMap.remove();
                    locationPickerMap = null;
                    selectedMarker = null;
                }
            }, 300);
        }
    });

    // Clean up map when modal is hidden
    document.getElementById('locationPickerModal').addEventListener('hidden.bs.modal', function() {
        if (locationPickerMap) {
            locationPickerMap.off();
            locationPickerMap.remove();
            locationPickerMap = null;
            selectedMarker = null;
        }
    });
});
</script>

<%- include('../partials/footer') %>
